<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://apis.google.com/js/api.js"></script>
  <link rel="stylesheet" href="calstyle.css" />
  <title>Derby Neck Library Calendar Project</title>
  <meta name="description"
    content="Developing an application to display a prettier calendar for the Derby Neck Library." />
</head>

<body>
  <h1 id="Header">Derby Neck Library Calendar Project</h1>
  <div class="container mt-5">
    <div class="layout">
      <div class="card">
        <h3 class="card-header" id="monthAndYear"></h3>
        <table class="table table-bordered table-responsive-sm" id="calendar">
          <thead>
            <tr>
              <th>Sunday</th>
              <th>Monday</th>
              <th>Tuesday</th>
              <th>Wednesday</th>
              <th>Thursday</th>
              <th>Friday</th>
              <th>Saturday</th>
            </tr>
          </thead>

          <tbody id="calendar-body">

          </tbody>
        </table>

        <div class="form-inline">

          <button class="btn btn-outline-primary col-sm-6" id="today"
            onclick="goToToday(); populateGoogleCal()">Today</button>

          <button class="btn btn-outline-primary col-sm-6" id="previous"
            onclick="previous(); populateGoogleCal();">Previous</button>

          <button class="btn btn-outline-primary col-sm-6" id="next" onclick="next(); populateGoogleCal()">Next</button>
        </div>
        <br />
        <form class="form-inline">
          <label class="lead mr-2 ml-2" for="month">Jump To: </label>
          <select class="form-control col-sm-4" name="month" id="month" onchange="jump(); populateGoogleCal()">
            <option value=0>Jan</option>
            <option value=1>Feb</option>
            <option value=2>Mar</option>
            <option value=3>Apr</option>
            <option value=4>May</option>
            <option value=5>Jun</option>
            <option value=6>Jul</option>
            <option value=7>Aug</option>
            <option value=8>Sep</option>
            <option value=9>Oct</option>
            <option value=10>Nov</option>
            <option value=11>Dec</option>
          </select>


          <label for="year"></label><select class="form-control col-sm-4" name="year" id="year"
            onchange="jump(); populateGoogleCal()">
            <option value=2024>2024</option>
            <option value=2025>2025</option>
            <option value=2026>2026</option>
            <option value=2027>2027</option>
            <option value=2028>2028</option>
            <option value=2029>2029</option>
            <option value=2030>2030</option>
          </select>
        </form>
      </div>

      <aside class="sidecol">
        <div class="card">
          <h4 class="card-header">Looking for something specific?</h4>
          <div class="p-3">
            <p>Filter and Searchbar will go <strong>here.</strong></p>
            <p><small>Notes, search, or upcoming events.</small></p>
          </div>
        </div>
      </aside>
    </div>
  </div>
  <!--<button name="jump" onclick="jump()">Go</button>-->

  <script>
    // await --- before we can continue, we have to wait for the response from another computer/the server
    //res = response
    async function populateGoogleCal() {

      var selectMonth = document.getElementById("month");
      var selectYear = document.getElementById("year");

      try {
        //fetch --- go get something from another computer/the server
        //res is a constant NOT CONSTRUCT, after RESOLVING THE PROMISE using .then, we grab the JSON body and store it in res
        //? denotes query parameters, which are used to send data to the server. in this case, we are sending the month and year 
        // selected by the user to the server, so that the server can get the correct events from the Google Calendar API.
        // document.getElementById IS CLIENT SIDE 
        const res = await fetch(`/api/callinggoogle?month=${selectMonth.value}&year=${selectYear.value}`).then((response) => response.json());
        //document.getElementById("rR").textContent = JSON.stringify(res);

        // Call AssignCalEvents after fetching data
        AssignCalEvents(res);
      } catch (error) {
        console.error("Error fetching calendar data:", error);
        document.getElementById("rR").textContent = "Sorry, Sarah. You messed up! Error loading calendar: " + error.message;
      }
    }

    function AssignCalEvents(res) {
      // Logic to assign calendar events to the calendar view goes here
      // This function would parse the 'res' object and update the calendar UI accordingly

      const thisMonthsEvents = res;
      
      console.log(thisMonthsEvents);

      // Clear previous events from calendar cells
      document.querySelectorAll('.event-item').forEach(el => el.remove());

      // Handle both array and object responses
      const events = Array.isArray(thisMonthsEvents) ? thisMonthsEvents : (thisMonthsEvents?.items || []);

      // Loop through each event
      events.forEach(event => {
        // Extract date from start dateTime (e.g., 2026-03-02T10:30:00-05:00)
        const startDateTime = new Date(event.start.dateTime);
        const year = startDateTime.getFullYear();
        const month = String(startDateTime.getMonth() + 1).padStart(2, '0');
        const day = String(startDateTime.getDate()).padStart(2, '0');
        const dateId = `date-${year}-${month}-${day}`;

        // Extract and format times
        const startTime = startDateTime.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        });
        const endDateTime = new Date(event.end.dateTime);
        const endTime = endDateTime.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        });

        // Find the matching calendar cell
        const cell = document.getElementById(dateId);
        if (cell) {
          // Create event container
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `
            <div class="event-summary"><a href="${event.htmlLink}" target="_blank"><strong>${event.summary}</strong></a></div>
            <div class="event-time">${startTime} - ${endTime}</div>
            <div class="event-description">${event.description}</div>
          `;
          //  <div class="event-description">${event.description}</div>
          cell.appendChild(eventEl);
        }
      });
    }

    // Wait for DOM to be fully loaded before calling
    document.addEventListener("DOMContentLoaded", function() {
      populateGoogleCal();
    });
  </script>

  </p>
  <div id="rR"></div>
  <script src="calendarview.js"></script>
</body>

</html>